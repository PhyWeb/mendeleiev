<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche des ressemblances</title>
    <link rel="stylesheet" href="style.css">
    <script src="data.js"></script>
    <script src="game.js"></script>
</head>
<body>
    <header>
        <h2>Recherche des familles</h2>
        <p>Vous devez maintenant étudier attentivement les fiches pour essayer, comme l'a fait Mendeleiev, de constituer des familles d'éléments à partir de leurs ressemblances de propriétés:</p>
        <ul>
            <li>Observez les propriétés physiques et chimiques.</li>
            <li>Observez les formules des corps simples et composés des éléments</li>
        </ul>
    </header>

    <div class="main-container">
        <section class="game-area">
            <div class="card-pool" id="pool" ondrop="drop(event)" ondragover="commonAllowDrop(event)"></div>
            
            <h3 style="margin-bottom:0; color: #006699;">Zone de test (glissez ici) :</h3>
            <div class="test-zone" id="test-box" ondrop="drop(event)" ondragover="commonAllowDrop(event)"></div>
            
            <div class="controls" style="border:none; padding: 10px 0 0 0;">
                <button class="btn" onclick="verifierFamille()">Valider ce groupe</button>
                <button class="btn" onclick="viderZoneTest()" style="background-color: #666;">Vider la zone</button>
                <div id="message-box"></div>
            </div>
        </section>

        <aside class="info-panel">
            <div class="info-header">
                <div id="info-symbole">--</div>
                <div id="info-nom">Survolez un élément</div>
            </div>
            <div class="info-item"><span class="info-label">Masse atomique (H=1)</span><span id="info-masse" class="info-value"></span></div>
            <div class="info-item"><span class="info-label">Formule corps simple</span><span id="info-formule" class="info-value"></span></div>
            <div class="info-item"><span class="info-label">Propriétés Physiques</span><span id="info-propPhy" class="info-value"></span></div>
            <div class="info-item"><span class="info-label">Propriétés Chimiques</span><span id="info-propChi" class="info-value"></span></div>
            <div class="info-item"><span class="info-label">Composés</span><span id="info-composes" class="info-value"></span></div>
        </aside>

        <div class="found-zone" id="found-zone">
            <div style="width: 100%; margin-bottom: 5px;">
                <h4 style="margin:0; color:#555;">Familles identifiées :</h4>
            </div>
        </div>
    </div>

    <footer class="controls">
        <div class="nav-links">
            <a href="partie1_03.html" class="link-simple">&larr; Retour</a>
            <a href="partie1_05.html" id="btn-suite" class="btn" style="display:none;">SUITE : La démarche &rarr;</a>
        </div>
    </footer>

    <script>
        const pool = document.getElementById('pool');
        const testBox = document.getElementById('test-box');
        const foundZone = document.getElementById('found-zone');
        let familiesFoundCount = 0;
        const foundFamilies = new Set();
        const totalFamilies = Object.keys(FAMILLES).length;

        // Génération des cartes via game.js en suivant l'ordre de masse
        ORDRE_MASSE.forEach(id => {
            if (id === "H") return; 

            const el = elementsData.find(e => e.id === id);
            if (!el) return;

            // Utilisation de la Factory commune
            const card = createCard(el);
            pool.appendChild(card);
        });

        // Fonction drop spécifique à cette page (gestion zone de test vs pool)
        function drop(ev) {
            ev.preventDefault();
            const el = document.getElementById(ev.dataTransfer.getData("text"));
            // On empêche de redéplacer les cartes validées (classe 'locked')
            if(!el || el.classList.contains('locked')) return;
            
            if (ev.currentTarget.id === 'test-box' || ev.currentTarget.id === 'pool') {
                ev.currentTarget.appendChild(el);
            }
        }

        function verifierFamille() {
            const children = Array.from(testBox.children);
            const msg = document.getElementById('message-box');
            
            if (children.length < 2) {
                msg.textContent = "Il faut au moins 2 éléments."; 
                msg.className = "msg-error"; 
                return;
            }

            const currentIds = children.map(c => c.id);
            const firstEl = elementsData.find(e => e.id === currentIds[0]);
            const targetFam = FAMILLES[firstEl.famille]; 
            const allCorrect = currentIds.every(id => targetFam.includes(id));

            if (!allCorrect) {
                msg.textContent = "Intrus détecté !"; 
                msg.className = "msg-error"; 
                testBox.style.borderColor = "#AA0055";
            } else {
                if (currentIds.length === targetFam.length) {
                    msg.innerHTML = "Famille complète trouvée !"; 
                    msg.className = "msg-success"; 
                    testBox.style.borderColor = "#00AA55";
                        archiverFamille(children);
                        const famId = firstEl.famille;
                        if (!foundFamilies.has(famId)) {
                            foundFamilies.add(famId);
                            familiesFoundCount = foundFamilies.size;
                        }
                        if (familiesFoundCount >= totalFamilies) {
                            document.getElementById('btn-suite').style.display = 'inline-block';
                            msg.textContent = "Toutes les familles ont été trouvées ! Vous pouvez passer à la suite.";
                            msg.className = "msg-success";
                        } else {
                            msg.innerHTML = `Famille complète trouvée&nbsp;! (${familiesFoundCount}/${totalFamilies})`;
                            msg.className = "msg-success";
                        }
                } 
                // --- NOUVEAU MESSAGE SPÉCIAL ICI ---
                else if (currentIds.length >= 2 && targetFam.length - currentIds.length === 1) {
                    msg.textContent = "Presque ! Il ne manque plus qu'un élément pour cette famille.";
                    msg.className = "msg-partial";
                    testBox.style.borderColor = "#FFCC00";
                } 
                else {
                    msg.textContent = "Famille incomplète."; 
                    msg.className = "msg-partial"; 
                    testBox.style.borderColor = "#FF6600";
                }
            }
            setTimeout(() => { testBox.style.borderColor = ""; }, 2000);
        }

        function viderZoneTest() {
            // 1. Remettre toutes les cartes de la zone de test dans le pool
            Array.from(testBox.children).forEach(c => pool.appendChild(c));
            
            // 2. Trier le pool selon l'ordre des masses défini par Mendeleïev
            const cards = Array.from(pool.children);
            
            cards.sort((a, b) => {
                // On compare la position des IDs dans le tableau ORDRE_MASSE
                const indexA = ORDRE_MASSE.indexOf(a.id);
                const indexB = ORDRE_MASSE.indexOf(b.id);
                return indexA - indexB;
            });

            // 3. Ré-injecter les cartes triées dans le pool
            cards.forEach(card => pool.appendChild(card));

            document.getElementById('message-box').textContent = "";
        }

        function archiverFamille(elements) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'found-group';
            elements.forEach(card => {
                // On retire les écouteurs pour figer la carte
                card.draggable = false; 
                card.classList.add('locked');
                // Note : Les écouteurs mouseover de game.js restent actifs, ce qui est bien (on peut toujours consulter les infos)
                groupDiv.appendChild(card);
            });
            foundZone.appendChild(groupDiv);
            setTimeout(() => { if(document.getElementById('message-box').className === 'msg-success') document.getElementById('message-box').textContent = ""; }, 3000);
        }
    </script>
</body>
</html>