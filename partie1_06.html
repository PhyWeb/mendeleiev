<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction du Tableau</title>
    <link rel="stylesheet" href="style.css">
    <script src="data.js"></script>
    <script src="game.js"></script>
</head>
<body>
    <header>
        <h2>Construction du Tableau</h2>
        <p>A ce stade et à l'aide des résultats précédents, vous devez constituer le tableau comme l'a fait Mendeleiev pour la première fois dans l'histoire de la chimie.</p>
        <p><strong>Une fois le tableau réalisé sur la table à l'aide des cartes,</strong> reproduisez le ci-dessous en déplaçant les vignettes vers les cases du tableau situé en bas de page avant de valider votre réponse.</p>
    </header>

    <div class="main-container">
        <section class="game-area">
        <div class="card-pool" id="pool" ondrop="handleCardDrop(event)" ondragover="commonAllowDrop(event)"></div>
            <div class="periodic-grid" id="grid"></div>
        </section>

        <aside class="info-panel">
            <div class="info-header">
                <div id="info-symbole">--</div>
                <div id="info-nom">Survolez un élément</div>
            </div>
            
            <div class="info-item">
                <span class="info-label">Masse atomique (H=1)</span>
                <span id="info-masse" class="info-value"></span>
            </div>
            <div class="info-item">
                <span class="info-label">Formule corps simple</span>
                <span id="info-formule" class="info-value"></span>
            </div>
            <div class="info-item">
                <span class="info-label">Propriétés Physiques</span>
                <span id="info-propPhy" class="info-value"></span>
            </div>
            <div class="info-item">
                <span class="info-label">Propriétés Chimiques</span>
                <span id="info-propChi" class="info-value"></span>
            </div>
            <div class="info-item">
                <span class="info-label">Composés</span>
                <span id="info-composes" class="info-value"></span>
            </div>
        </aside>
    </div>

    <footer class="controls">
        <button class="btn" onclick="validerTableau()">Valider le tableau</button>
        <div id="message-box"></div>
        <div class="nav-links">
             <a href="partie1_07.html" id="btn-suite" class="btn" style="display:none;">SUITE : Le cas de l'Hydrogène &rarr;</a>
        </div>
    </footer>

    <script>
        const pool = document.getElementById('pool');
        const grid = document.getElementById('grid');

        // Génération grille 4x8 (32 cases)
        for(let i=8; i<32; i++) {
            let slot = document.createElement('div');
            slot.className = 'slot'; // La classe 'slot' est maintenant reconnue par game.js
            slot.setAttribute('data-index', i);
            
            // UTILISATION DE LA FONCTION CENTRALISÉE
            slot.ondrop = handleCardDrop; 
            slot.ondragover = commonAllowDrop; 
            
            grid.appendChild(slot);
        }

        // Remplissage initial (Trié)
        const sortedData = [...elementsData].sort((a, b) => {
            let mA = parseFloat(a.masse.replace(',', '.').replace('~', ''));
            let mB = parseFloat(b.masse.replace(',', '.').replace('~', ''));
            return mA - mB;
        });

        sortedData.forEach(el => {
            if(el.id === "H") return; 
            if(!el.famille) return;
            pool.appendChild(createCard(el));
        });

        // La fonction de validation reste locale car spécifique à cet exercice (vérifie data.pos)
        function validerTableau() {
            let errors = 0;
            document.querySelectorAll('.element-card').forEach(card => {
                if(card.parentElement.classList.contains('slot')) {
                    let slotIdx = parseInt(card.parentElement.getAttribute('data-index'));
                    let data = elementsData.find(e => e.id === card.id);
                    if(data && slotIdx === data.pos) {
                        card.className = "element-card correct";
                    } else {
                        card.className = "element-card incorrect";
                        errors++;
                    }
                } else {
                    errors++; 
                }
            });

            let msg = document.getElementById('message-box');
            if(errors === 0 && pool.children.length === 0) {
                msg.innerHTML = "Bravo ! Tableau reconstruit."; msg.className = "msg-success";
                document.getElementById('btn-suite').style.display = 'inline-block';
            } else {
                msg.innerHTML = "Tableau incomplet ou erreurs (en rouge)."; msg.className = "msg-error";
            }
        }
    </script>
</body>
</html>